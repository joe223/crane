"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validateBuildConfig = validateBuildConfig;
exports.resolvePath = resolvePath;
exports.createBuilderConfig = createBuilderConfig;
exports.builder = builder;

var _path = _interopRequireDefault(require("path"));

var _shared = require("@cranejs/shared");

var _miniCssExtractPlugin = _interopRequireDefault(require("mini-css-extract-plugin"));

var _webpack = _interopRequireDefault(require("webpack"));

var _webpackDevServer = _interopRequireDefault(require("webpack-dev-server"));

var _webpackMerge = _interopRequireDefault(require("webpack-merge"));

var _copyWebpackPlugin = _interopRequireDefault(require("copy-webpack-plugin"));

var _htmlWebpackPlugin = _interopRequireDefault(require("html-webpack-plugin"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const cwd = process.cwd();

function loadPlugin(name) {
  return require(require.resolve(name, {
    paths: [cwd, __dirname, _path.default.resolve(__dirname, '../')]
  })).default;
}

function validateBuildConfig(buildConfig, moduleName) {
  if (!buildConfig.entry && (!buildConfig.entries || buildConfig.entries.length === 0)) {
    _shared.logger.error(`module [${moduleName}] required a entry`);

    process.exit(1);
  }
}

function resolvePath(filePath) {
  return _path.default.isAbsolute(filePath) ? filePath : _path.default.join(cwd, './modules', filePath);
}

function createBuilderConfig(pageConfig, moduleName, clientEnv, buildType) {
  const configBuilder = require(`./webpackConfig/webpack.${buildType}.conf`).default(pageConfig, moduleName, clientEnv, buildType);

  const baseOutput = pageConfig.output || moduleName;
  validateBuildConfig(pageConfig, moduleName);

  _shared.config.plugins.forEach(plugin => {
    let [resolvedPlugin, options] = typeof plugin === 'string' // string
    ? [loadPlugin(plugin)] // [plugin, option]
    : Array.isArray(plugin) ? typeof plugin[0] === 'function' ? [plugin[0], plugin[1]] : [loadPlugin(plugin[0]), plugin[1]] : // function
    [plugin];
    resolvedPlugin({
      configBuilder,
      pageConfig,
      moduleName,
      clientEnv,
      buildType
    }, options);
  });

  const baseConfig = configBuilder.toConfig();
  const extendConfig = {
    entry: {},
    plugins: []
  }; // Single entry file

  if (pageConfig.entry) {
    const entry = pageConfig;
    const defaultEntryName = 'index';
    entry.templateParameters = {
      WEB_ENV: clientEnv,
      ...entry.templateParameters
    };
    extendConfig.entry[defaultEntryName] = resolvePath(entry.entry);
    extendConfig.plugins.push(genHtmlWebpackPluginConfig(buildType, entry, defaultEntryName, 'index.html')); // Multiple entry file
  } else {
    Object.keys(pageConfig.entries).forEach(entryName => {
      const entry = pageConfig.entries[entryName];
      entry.templateParameters = {
        WEB_ENV: clientEnv,
        ...entry.templateParameters
      };
      extendConfig.entry[entryName] = resolvePath(entry.entry);
      extendConfig.plugins.push(genHtmlWebpackPluginConfig(buildType, entry, entryName, entry.output || _path.default.join(entryName, 'index.html')));
    });
  }

  if (buildType === _shared.BuildType.prod) {
    extendConfig.plugins.push(new _miniCssExtractPlugin.default({
      // Options similar to the same options in webpackOptions.output
      // both options are optional
      filename: '[name].[chunkhash].css',
      chunkFilename: '[id].[chunkhash].css'
    }));
  } // Set public static assets
  // copy custom static assets


  if (pageConfig.static) {
    const staticAssets = [{
      from: resolvePath(pageConfig.static),
      to: _shared.config.assetsSubDirectory,
      globOptions: {
        dot: false
      }
    }];
    extendConfig.plugins.push(new _copyWebpackPlugin.default({
      patterns: staticAssets,
      options: {
        concurrency: 100
      }
    }));
  }

  const webpackConfig = (0, _webpackMerge.default)(baseConfig, {
    output: {
      path: _path.default.join(_shared.config.assetsRoot, baseOutput),
      filename: '[name].[chunkhash].js',
      publicPath: _path.default.join(_path.default.sep, baseOutput, _path.default.sep)
    },
    plugins: [new _webpack.default.EnvironmentPlugin(clientEnv)]
  }, extendConfig, pageConfig.webpack || {});
  return webpackConfig;
}

function builder(builderConfig, dev = false) {
  if (dev) {
    const options = builderConfig.find(conf => Boolean(conf.devServer)).devServer;
    const server = new _webpackDevServer.default((0, _webpack.default)(builderConfig), options);
    server.listen(options.port, 'localhost', function (err) {
      if (err) {
        console.log(err);
      }

      console.log('WebpackDevServer listening at localhost:', options.port);
    });
  } else {
    (0, _webpack.default)(builderConfig, (err, stats) => {
      // https://webpack.js.org/api/node/#error-handling
      if (err) {
        console.error(err.stack || err);

        if (err.details) {
          console.error(err.details);
        }

        return;
      }

      const info = stats.toJson();

      if (stats.hasErrors()) {
        console.error(info.errors);
      }

      if (stats.hasWarnings()) {
        console.warn(info.warnings);
      }
    });
  }
}
/**
 * The default for options.templateParameter
 * Generate the template parameters
 */


function genTemplateParametersGenerator(entry) {
  return function templateParametersGenerator(compilation, assets, options) {
    // Try to use absolute path while loading stylesheet
    if (assets.extracted && assets.extracted.css) {
      assets.extracted.css.forEach(css => {
        if (!_path.default.isAbsolute(css.file) && css.file.indexOf(assets.publicPath) < 0) {
          css.file = _path.default.join(assets.publicPath, css.file);
        }
      });
    }

    return {
      title: entry.title || entry.templateParameters.title,
      ...entry.templateParameters,
      compilation,
      webpackConfig: entry.options,
      htmlWebpackPlugin: {
        files: assets,
        options: options
      }
    };
  };
}
/**
 * Factory function for generating HTMLWebpackPlugin instance
 * @param {string} buildType 'dev' | 'prod'
 * @param {{
 *  title,
 *  entry,
 *  output,
 *  template?,
 *  templateParameters?}} entry
 * @param entryName
 * @param {string} htmlFilename
 * @returns {HtmlWebpackPlugin}
 */


function genHtmlWebpackPluginConfig(buildType, entry, entryName, filename = 'index.html') {
  const template = entry.template ? resolvePath(entry.template) : _shared.config.defaultTemplate;

  if (buildType === _shared.BuildType.dev) {
    return new _htmlWebpackPlugin.default({
      filename,
      template,
      inject: true,
      chunks: ['vendors', entryName],
      title: entry.title || entry.templateParameters.title,
      templateParameters: genTemplateParametersGenerator(entry)
    });
  } else {
    return new _htmlWebpackPlugin.default({
      filename,
      template,
      inject: true,
      chunks: ['vendors', entryName],
      title: entry.title || entry.templateParameters.title,
      templateParameters: genTemplateParametersGenerator(entry),
      minify: {
        removeComments: true,
        collapseWhitespace: true,
        removeAttributeQuotes: true // more options:
        // https://github.com/kangax/html-minifier#options-quick-reference

      },
      // necessary to consistently work with multiple chunks via CommonsChunkPlugin
      chunksSortMode: 'auto'
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjd2QiLCJwcm9jZXNzIiwibG9hZFBsdWdpbiIsIm5hbWUiLCJyZXF1aXJlIiwicmVzb2x2ZSIsInBhdGhzIiwiX19kaXJuYW1lIiwicGF0aCIsImRlZmF1bHQiLCJ2YWxpZGF0ZUJ1aWxkQ29uZmlnIiwiYnVpbGRDb25maWciLCJtb2R1bGVOYW1lIiwiZW50cnkiLCJlbnRyaWVzIiwibGVuZ3RoIiwibG9nZ2VyIiwiZXJyb3IiLCJleGl0IiwicmVzb2x2ZVBhdGgiLCJmaWxlUGF0aCIsImlzQWJzb2x1dGUiLCJqb2luIiwiY3JlYXRlQnVpbGRlckNvbmZpZyIsInBhZ2VDb25maWciLCJjbGllbnRFbnYiLCJidWlsZFR5cGUiLCJjb25maWdCdWlsZGVyIiwiYmFzZU91dHB1dCIsIm91dHB1dCIsImNvbmZpZyIsInBsdWdpbnMiLCJmb3JFYWNoIiwicGx1Z2luIiwicmVzb2x2ZWRQbHVnaW4iLCJvcHRpb25zIiwiQXJyYXkiLCJpc0FycmF5IiwiYmFzZUNvbmZpZyIsInRvQ29uZmlnIiwiZXh0ZW5kQ29uZmlnIiwiZGVmYXVsdEVudHJ5TmFtZSIsInRlbXBsYXRlUGFyYW1ldGVycyIsIldFQl9FTlYiLCJwdXNoIiwiZ2VuSHRtbFdlYnBhY2tQbHVnaW5Db25maWciLCJPYmplY3QiLCJrZXlzIiwiZW50cnlOYW1lIiwiQnVpbGRUeXBlIiwicHJvZCIsIk1pbmlDc3NFeHRyYWN0UGx1Z2luIiwiZmlsZW5hbWUiLCJjaHVua0ZpbGVuYW1lIiwic3RhdGljIiwic3RhdGljQXNzZXRzIiwiZnJvbSIsInRvIiwiYXNzZXRzU3ViRGlyZWN0b3J5IiwiZ2xvYk9wdGlvbnMiLCJkb3QiLCJDb3B5V2VicGFja1BsdWdpbiIsInBhdHRlcm5zIiwiY29uY3VycmVuY3kiLCJ3ZWJwYWNrQ29uZmlnIiwiYXNzZXRzUm9vdCIsInB1YmxpY1BhdGgiLCJzZXAiLCJ3ZWJwYWNrIiwiRW52aXJvbm1lbnRQbHVnaW4iLCJidWlsZGVyIiwiYnVpbGRlckNvbmZpZyIsImRldiIsImZpbmQiLCJjb25mIiwiQm9vbGVhbiIsImRldlNlcnZlciIsInNlcnZlciIsIldlYnBhY2tEZXZTZXJ2ZXIiLCJsaXN0ZW4iLCJwb3J0IiwiZXJyIiwiY29uc29sZSIsImxvZyIsInN0YXRzIiwic3RhY2siLCJkZXRhaWxzIiwiaW5mbyIsInRvSnNvbiIsImhhc0Vycm9ycyIsImVycm9ycyIsImhhc1dhcm5pbmdzIiwid2FybiIsIndhcm5pbmdzIiwiZ2VuVGVtcGxhdGVQYXJhbWV0ZXJzR2VuZXJhdG9yIiwidGVtcGxhdGVQYXJhbWV0ZXJzR2VuZXJhdG9yIiwiY29tcGlsYXRpb24iLCJhc3NldHMiLCJleHRyYWN0ZWQiLCJjc3MiLCJmaWxlIiwiaW5kZXhPZiIsInRpdGxlIiwiaHRtbFdlYnBhY2tQbHVnaW4iLCJmaWxlcyIsInRlbXBsYXRlIiwiZGVmYXVsdFRlbXBsYXRlIiwiSHRtbFdlYnBhY2tQbHVnaW4iLCJpbmplY3QiLCJjaHVua3MiLCJtaW5pZnkiLCJyZW1vdmVDb21tZW50cyIsImNvbGxhcHNlV2hpdGVzcGFjZSIsInJlbW92ZUF0dHJpYnV0ZVF1b3RlcyIsImNodW5rc1NvcnRNb2RlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUdDLE9BQU8sQ0FBQ0QsR0FBUixFQUFaOztBQUVBLFNBQVNFLFVBQVQsQ0FBcUJDLElBQXJCLEVBQTJCO0FBQ3ZCLFNBQU9DLE9BQU8sQ0FBQ0EsT0FBTyxDQUFDQyxPQUFSLENBQWdCRixJQUFoQixFQUFzQjtBQUNqQ0csSUFBQUEsS0FBSyxFQUFFLENBQ0hOLEdBREcsRUFFSE8sU0FGRyxFQUdIQyxjQUFLSCxPQUFMLENBQWFFLFNBQWIsRUFBd0IsS0FBeEIsQ0FIRztBQUQwQixHQUF0QixDQUFELENBQVAsQ0FNSEUsT0FOSjtBQU9IOztBQUVNLFNBQVNDLG1CQUFULENBQTZCQyxXQUE3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XG5pbXBvcnQgeyBjb25maWcsIGxvZ2dlciwgQnVpbGRUeXBlIH0gZnJvbSAnQGNyYW5lanMvc2hhcmVkJ1xuaW1wb3J0IE1pbmlDc3NFeHRyYWN0UGx1Z2luIGZyb20gJ21pbmktY3NzLWV4dHJhY3QtcGx1Z2luJ1xuaW1wb3J0IHdlYnBhY2sgZnJvbSAnd2VicGFjaydcbmltcG9ydCBXZWJwYWNrRGV2U2VydmVyIGZyb20gJ3dlYnBhY2stZGV2LXNlcnZlcidcbmltcG9ydCBtZXJnZSBmcm9tICd3ZWJwYWNrLW1lcmdlJ1xuaW1wb3J0IENvcHlXZWJwYWNrUGx1Z2luIGZyb20gJ2NvcHktd2VicGFjay1wbHVnaW4nXG5pbXBvcnQgSHRtbFdlYnBhY2tQbHVnaW4gZnJvbSAnaHRtbC13ZWJwYWNrLXBsdWdpbidcblxuY29uc3QgY3dkID0gcHJvY2Vzcy5jd2QoKVxuXG5mdW5jdGlvbiBsb2FkUGx1Z2luIChuYW1lKSB7XG4gICAgcmV0dXJuIHJlcXVpcmUocmVxdWlyZS5yZXNvbHZlKG5hbWUsIHtcbiAgICAgICAgcGF0aHM6IFtcbiAgICAgICAgICAgIGN3ZCxcbiAgICAgICAgICAgIF9fZGlybmFtZSxcbiAgICAgICAgICAgIHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8nKVxuICAgICAgICBdXG4gICAgfSkpLmRlZmF1bHRcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlQnVpbGRDb25maWcoYnVpbGRDb25maWcsIG1vZHVsZU5hbWUpIHtcbiAgICBpZiAoXG4gICAgICAgICFidWlsZENvbmZpZy5lbnRyeSAmJlxuICAgICAgICAoIWJ1aWxkQ29uZmlnLmVudHJpZXMgfHwgYnVpbGRDb25maWcuZW50cmllcy5sZW5ndGggPT09IDApXG4gICAgKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihgbW9kdWxlIFske21vZHVsZU5hbWV9XSByZXF1aXJlZCBhIGVudHJ5YClcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpXG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZVBhdGgoZmlsZVBhdGgpIHtcbiAgICByZXR1cm4gcGF0aC5pc0Fic29sdXRlKGZpbGVQYXRoKVxuICAgICAgICA/IGZpbGVQYXRoXG4gICAgICAgIDogcGF0aC5qb2luKGN3ZCwgJy4vbW9kdWxlcycsIGZpbGVQYXRoKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQnVpbGRlckNvbmZpZyhcbiAgICBwYWdlQ29uZmlnLFxuICAgIG1vZHVsZU5hbWUsXG4gICAgY2xpZW50RW52LFxuICAgIGJ1aWxkVHlwZVxuKSB7XG4gICAgY29uc3QgY29uZmlnQnVpbGRlciA9IHJlcXVpcmUoYC4vd2VicGFja0NvbmZpZy93ZWJwYWNrLiR7YnVpbGRUeXBlfS5jb25mYCkuZGVmYXVsdChcbiAgICAgICAgcGFnZUNvbmZpZyxcbiAgICAgICAgbW9kdWxlTmFtZSxcbiAgICAgICAgY2xpZW50RW52LFxuICAgICAgICBidWlsZFR5cGVcbiAgICApXG4gICAgY29uc3QgYmFzZU91dHB1dCA9IHBhZ2VDb25maWcub3V0cHV0IHx8IG1vZHVsZU5hbWVcblxuICAgIHZhbGlkYXRlQnVpbGRDb25maWcocGFnZUNvbmZpZywgbW9kdWxlTmFtZSlcblxuICAgIGNvbmZpZy5wbHVnaW5zLmZvckVhY2gocGx1Z2luID0+IHtcbiAgICAgICAgbGV0IFtyZXNvbHZlZFBsdWdpbiwgb3B0aW9uc10gPSB0eXBlb2YgcGx1Z2luID09PSAnc3RyaW5nJ1xuICAgICAgICAgICAgLy8gc3RyaW5nXG4gICAgICAgICAgICA/IFtsb2FkUGx1Z2luKHBsdWdpbildXG4gICAgICAgICAgICAvLyBbcGx1Z2luLCBvcHRpb25dXG4gICAgICAgICAgICA6IChcbiAgICAgICAgICAgICAgICBBcnJheS5pc0FycmF5KHBsdWdpbilcbiAgICAgICAgICAgICAgICA/ICh0eXBlb2YgcGx1Z2luWzBdID09PSAnZnVuY3Rpb24nXG4gICAgICAgICAgICAgICAgICAgID8gW3BsdWdpblswXSwgcGx1Z2luWzFdXVxuICAgICAgICAgICAgICAgICAgICA6IFtsb2FkUGx1Z2luKHBsdWdpblswXSksIHBsdWdpblsxXV0pXG4gICAgICAgICAgICAgICAgLy8gZnVuY3Rpb25cbiAgICAgICAgICAgICAgICA6IFtwbHVnaW5dXG4gICAgICAgICAgICApXG5cbiAgICAgICAgcmVzb2x2ZWRQbHVnaW4oe1xuICAgICAgICAgICAgY29uZmlnQnVpbGRlcixcbiAgICAgICAgICAgIHBhZ2VDb25maWcsXG4gICAgICAgICAgICBtb2R1bGVOYW1lLFxuICAgICAgICAgICAgY2xpZW50RW52LFxuICAgICAgICAgICAgYnVpbGRUeXBlXG4gICAgICAgIH0sIG9wdGlvbnMpXG4gICAgfSlcblxuICAgIGNvbnN0IGJhc2VDb25maWcgPSBjb25maWdCdWlsZGVyLnRvQ29uZmlnKClcbiAgICBjb25zdCBleHRlbmRDb25maWcgPSB7XG4gICAgICAgIGVudHJ5OiB7fSxcbiAgICAgICAgcGx1Z2luczogW10sXG4gICAgfVxuXG4gICAgLy8gU2luZ2xlIGVudHJ5IGZpbGVcbiAgICBpZiAocGFnZUNvbmZpZy5lbnRyeSkge1xuICAgICAgICBjb25zdCBlbnRyeSA9IHBhZ2VDb25maWdcbiAgICAgICAgY29uc3QgZGVmYXVsdEVudHJ5TmFtZSA9ICdpbmRleCdcblxuICAgICAgICBlbnRyeS50ZW1wbGF0ZVBhcmFtZXRlcnMgPSB7XG4gICAgICAgICAgICBXRUJfRU5WOiBjbGllbnRFbnYsXG4gICAgICAgICAgICAuLi5lbnRyeS50ZW1wbGF0ZVBhcmFtZXRlcnMsXG4gICAgICAgIH1cblxuICAgICAgICBleHRlbmRDb25maWcuZW50cnlbZGVmYXVsdEVudHJ5TmFtZV0gPSByZXNvbHZlUGF0aChlbnRyeS5lbnRyeSlcbiAgICAgICAgZXh0ZW5kQ29uZmlnLnBsdWdpbnMucHVzaChcbiAgICAgICAgICAgIGdlbkh0bWxXZWJwYWNrUGx1Z2luQ29uZmlnKFxuICAgICAgICAgICAgICAgIGJ1aWxkVHlwZSxcbiAgICAgICAgICAgICAgICBlbnRyeSxcbiAgICAgICAgICAgICAgICBkZWZhdWx0RW50cnlOYW1lLFxuICAgICAgICAgICAgICAgICdpbmRleC5odG1sJ1xuICAgICAgICAgICAgKVxuICAgICAgICApXG4gICAgICAgIC8vIE11bHRpcGxlIGVudHJ5IGZpbGVcbiAgICB9IGVsc2Uge1xuICAgICAgICBPYmplY3Qua2V5cyhwYWdlQ29uZmlnLmVudHJpZXMpLmZvckVhY2goKGVudHJ5TmFtZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZW50cnkgPSBwYWdlQ29uZmlnLmVudHJpZXNbZW50cnlOYW1lXVxuXG4gICAgICAgICAgICBlbnRyeS50ZW1wbGF0ZVBhcmFtZXRlcnMgPSB7XG4gICAgICAgICAgICAgICAgV0VCX0VOVjogY2xpZW50RW52LFxuICAgICAgICAgICAgICAgIC4uLmVudHJ5LnRlbXBsYXRlUGFyYW1ldGVycyxcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZXh0ZW5kQ29uZmlnLmVudHJ5W2VudHJ5TmFtZV0gPSByZXNvbHZlUGF0aChlbnRyeS5lbnRyeSlcbiAgICAgICAgICAgIGV4dGVuZENvbmZpZy5wbHVnaW5zLnB1c2goXG4gICAgICAgICAgICAgICAgZ2VuSHRtbFdlYnBhY2tQbHVnaW5Db25maWcoXG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgZW50cnksXG4gICAgICAgICAgICAgICAgICAgIGVudHJ5TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgZW50cnkub3V0cHV0IHx8IHBhdGguam9pbihlbnRyeU5hbWUsICdpbmRleC5odG1sJylcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgaWYgKGJ1aWxkVHlwZSA9PT0gQnVpbGRUeXBlLnByb2QpIHtcbiAgICAgICAgZXh0ZW5kQ29uZmlnLnBsdWdpbnMucHVzaChcbiAgICAgICAgICAgIG5ldyBNaW5pQ3NzRXh0cmFjdFBsdWdpbih7XG4gICAgICAgICAgICAgICAgLy8gT3B0aW9ucyBzaW1pbGFyIHRvIHRoZSBzYW1lIG9wdGlvbnMgaW4gd2VicGFja09wdGlvbnMub3V0cHV0XG4gICAgICAgICAgICAgICAgLy8gYm90aCBvcHRpb25zIGFyZSBvcHRpb25hbFxuICAgICAgICAgICAgICAgIGZpbGVuYW1lOiAnW25hbWVdLltjaHVua2hhc2hdLmNzcycsXG4gICAgICAgICAgICAgICAgY2h1bmtGaWxlbmFtZTogJ1tpZF0uW2NodW5raGFzaF0uY3NzJ1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgIH1cblxuXG4gICAgLy8gU2V0IHB1YmxpYyBzdGF0aWMgYXNzZXRzXG4gICAgLy8gY29weSBjdXN0b20gc3RhdGljIGFzc2V0c1xuICAgIGlmIChwYWdlQ29uZmlnLnN0YXRpYykge1xuICAgICAgICBjb25zdCBzdGF0aWNBc3NldHMgPSBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZnJvbTogcmVzb2x2ZVBhdGgocGFnZUNvbmZpZy5zdGF0aWMpLFxuICAgICAgICAgICAgICAgIHRvOiBjb25maWcuYXNzZXRzU3ViRGlyZWN0b3J5LFxuICAgICAgICAgICAgICAgIGdsb2JPcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgICAgIGRvdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIF1cblxuICAgICAgICBleHRlbmRDb25maWcucGx1Z2lucy5wdXNoKFxuICAgICAgICAgICAgbmV3IENvcHlXZWJwYWNrUGx1Z2luKHtcbiAgICAgICAgICAgICAgICBwYXR0ZXJuczogc3RhdGljQXNzZXRzLFxuICAgICAgICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICAgICAgY29uY3VycmVuY3k6IDEwMCxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgIH1cblxuICAgIGNvbnN0IHdlYnBhY2tDb25maWcgPSBtZXJnZShcbiAgICAgICAgYmFzZUNvbmZpZyxcbiAgICAgICAge1xuICAgICAgICAgICAgb3V0cHV0OiB7XG4gICAgICAgICAgICAgICAgcGF0aDogcGF0aC5qb2luKGNvbmZpZy5hc3NldHNSb290LCBiYXNlT3V0cHV0KSxcbiAgICAgICAgICAgICAgICBmaWxlbmFtZTogJ1tuYW1lXS5bY2h1bmtoYXNoXS5qcycsXG4gICAgICAgICAgICAgICAgcHVibGljUGF0aDogcGF0aC5qb2luKHBhdGguc2VwLCBiYXNlT3V0cHV0LCBwYXRoLnNlcCksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcGx1Z2luczogW25ldyB3ZWJwYWNrLkVudmlyb25tZW50UGx1Z2luKGNsaWVudEVudildLFxuICAgICAgICB9LFxuICAgICAgICBleHRlbmRDb25maWcsXG4gICAgICAgIHBhZ2VDb25maWcud2VicGFjayB8fCB7fVxuICAgIClcblxuICAgIHJldHVybiB3ZWJwYWNrQ29uZmlnXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZGVyKGJ1aWxkZXJDb25maWcsIGRldiA9IGZhbHNlKSB7XG4gICAgaWYgKGRldikge1xuICAgICAgICBjb25zdCBvcHRpb25zID0gYnVpbGRlckNvbmZpZy5maW5kKGNvbmYgPT4gQm9vbGVhbihjb25mLmRldlNlcnZlcikpLmRldlNlcnZlclxuICAgICAgICBjb25zdCBzZXJ2ZXIgPSBuZXcgV2VicGFja0RldlNlcnZlcih3ZWJwYWNrKGJ1aWxkZXJDb25maWcpLCBvcHRpb25zKVxuXG4gICAgICAgIHNlcnZlci5saXN0ZW4ob3B0aW9ucy5wb3J0LCAnbG9jYWxob3N0JywgZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycilcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICAgICdXZWJwYWNrRGV2U2VydmVyIGxpc3RlbmluZyBhdCBsb2NhbGhvc3Q6JyxcbiAgICAgICAgICAgICAgICBvcHRpb25zLnBvcnRcbiAgICAgICAgICAgIClcbiAgICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgICB3ZWJwYWNrKGJ1aWxkZXJDb25maWcsIChlcnIsIHN0YXRzKSA9PiB7XG4gICAgICAgICAgICAvLyBodHRwczovL3dlYnBhY2suanMub3JnL2FwaS9ub2RlLyNlcnJvci1oYW5kbGluZ1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLnN0YWNrIHx8IGVycik7XG4gICAgICAgICAgICAgICAgaWYgKGVyci5kZXRhaWxzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLmRldGFpbHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGluZm8gPSBzdGF0cy50b0pzb24oKTtcblxuICAgICAgICAgICAgaWYgKHN0YXRzLmhhc0Vycm9ycygpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihpbmZvLmVycm9ycyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChzdGF0cy5oYXNXYXJuaW5ncygpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGluZm8ud2FybmluZ3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG5cbi8qKlxuICogVGhlIGRlZmF1bHQgZm9yIG9wdGlvbnMudGVtcGxhdGVQYXJhbWV0ZXJcbiAqIEdlbmVyYXRlIHRoZSB0ZW1wbGF0ZSBwYXJhbWV0ZXJzXG4gKi9cbmZ1bmN0aW9uIGdlblRlbXBsYXRlUGFyYW1ldGVyc0dlbmVyYXRvcihlbnRyeSkge1xuICAgIHJldHVybiBmdW5jdGlvbiB0ZW1wbGF0ZVBhcmFtZXRlcnNHZW5lcmF0b3IoY29tcGlsYXRpb24sIGFzc2V0cywgb3B0aW9ucykge1xuICAgICAgICAvLyBUcnkgdG8gdXNlIGFic29sdXRlIHBhdGggd2hpbGUgbG9hZGluZyBzdHlsZXNoZWV0XG4gICAgICAgIGlmIChhc3NldHMuZXh0cmFjdGVkICYmIGFzc2V0cy5leHRyYWN0ZWQuY3NzKSB7XG4gICAgICAgICAgICBhc3NldHMuZXh0cmFjdGVkLmNzcy5mb3JFYWNoKChjc3MpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgICFwYXRoLmlzQWJzb2x1dGUoY3NzLmZpbGUpICYmXG4gICAgICAgICAgICAgICAgICAgIGNzcy5maWxlLmluZGV4T2YoYXNzZXRzLnB1YmxpY1BhdGgpIDwgMFxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBjc3MuZmlsZSA9IHBhdGguam9pbihhc3NldHMucHVibGljUGF0aCwgY3NzLmZpbGUpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdGl0bGU6IGVudHJ5LnRpdGxlIHx8IGVudHJ5LnRlbXBsYXRlUGFyYW1ldGVycy50aXRsZSxcbiAgICAgICAgICAgIC4uLmVudHJ5LnRlbXBsYXRlUGFyYW1ldGVycyxcbiAgICAgICAgICAgIGNvbXBpbGF0aW9uLFxuICAgICAgICAgICAgd2VicGFja0NvbmZpZzogZW50cnkub3B0aW9ucyxcbiAgICAgICAgICAgIGh0bWxXZWJwYWNrUGx1Z2luOiB7XG4gICAgICAgICAgICAgICAgZmlsZXM6IGFzc2V0cyxcbiAgICAgICAgICAgICAgICBvcHRpb25zOiBvcHRpb25zLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgIH1cbn1cblxuLyoqXG4gKiBGYWN0b3J5IGZ1bmN0aW9uIGZvciBnZW5lcmF0aW5nIEhUTUxXZWJwYWNrUGx1Z2luIGluc3RhbmNlXG4gKiBAcGFyYW0ge3N0cmluZ30gYnVpbGRUeXBlICdkZXYnIHwgJ3Byb2QnXG4gKiBAcGFyYW0ge3tcbiAqICB0aXRsZSxcbiAqICBlbnRyeSxcbiAqICBvdXRwdXQsXG4gKiAgdGVtcGxhdGU/LFxuICogIHRlbXBsYXRlUGFyYW1ldGVycz99fSBlbnRyeVxuICogQHBhcmFtIGVudHJ5TmFtZVxuICogQHBhcmFtIHtzdHJpbmd9IGh0bWxGaWxlbmFtZVxuICogQHJldHVybnMge0h0bWxXZWJwYWNrUGx1Z2lufVxuICovXG5mdW5jdGlvbiBnZW5IdG1sV2VicGFja1BsdWdpbkNvbmZpZyhcbiAgICBidWlsZFR5cGUsXG4gICAgZW50cnksXG4gICAgZW50cnlOYW1lLFxuICAgIGZpbGVuYW1lID0gJ2luZGV4Lmh0bWwnXG4pIHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGVudHJ5LnRlbXBsYXRlXG4gICAgICAgID8gcmVzb2x2ZVBhdGgoZW50cnkudGVtcGxhdGUpXG4gICAgICAgIDogY29uZmlnLmRlZmF1bHRUZW1wbGF0ZVxuXG4gICAgaWYgKGJ1aWxkVHlwZSA9PT0gQnVpbGRUeXBlLmRldikge1xuICAgICAgICByZXR1cm4gbmV3IEh0bWxXZWJwYWNrUGx1Z2luKHtcbiAgICAgICAgICAgIGZpbGVuYW1lLFxuICAgICAgICAgICAgdGVtcGxhdGUsXG4gICAgICAgICAgICBpbmplY3Q6IHRydWUsXG4gICAgICAgICAgICBjaHVua3M6IFsndmVuZG9ycycsIGVudHJ5TmFtZV0sXG4gICAgICAgICAgICB0aXRsZTogZW50cnkudGl0bGUgfHwgZW50cnkudGVtcGxhdGVQYXJhbWV0ZXJzLnRpdGxlLFxuICAgICAgICAgICAgdGVtcGxhdGVQYXJhbWV0ZXJzOiBnZW5UZW1wbGF0ZVBhcmFtZXRlcnNHZW5lcmF0b3IoZW50cnkpXG4gICAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG5ldyBIdG1sV2VicGFja1BsdWdpbih7XG4gICAgICAgICAgICBmaWxlbmFtZSxcbiAgICAgICAgICAgIHRlbXBsYXRlLFxuICAgICAgICAgICAgaW5qZWN0OiB0cnVlLFxuICAgICAgICAgICAgY2h1bmtzOiBbJ3ZlbmRvcnMnLCBlbnRyeU5hbWVdLFxuICAgICAgICAgICAgdGl0bGU6IGVudHJ5LnRpdGxlIHx8IGVudHJ5LnRlbXBsYXRlUGFyYW1ldGVycy50aXRsZSxcbiAgICAgICAgICAgIHRlbXBsYXRlUGFyYW1ldGVyczogZ2VuVGVtcGxhdGVQYXJhbWV0ZXJzR2VuZXJhdG9yKGVudHJ5KSxcbiAgICAgICAgICAgIG1pbmlmeToge1xuICAgICAgICAgICAgICAgIHJlbW92ZUNvbW1lbnRzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGNvbGxhcHNlV2hpdGVzcGFjZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICByZW1vdmVBdHRyaWJ1dGVRdW90ZXM6IHRydWUsXG4gICAgICAgICAgICAgICAgLy8gbW9yZSBvcHRpb25zOlxuICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9rYW5nYXgvaHRtbC1taW5pZmllciNvcHRpb25zLXF1aWNrLXJlZmVyZW5jZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC8vIG5lY2Vzc2FyeSB0byBjb25zaXN0ZW50bHkgd29yayB3aXRoIG11bHRpcGxlIGNodW5rcyB2aWEgQ29tbW9uc0NodW5rUGx1Z2luXG4gICAgICAgICAgICBjaHVua3NTb3J0TW9kZTogJ2F1dG8nXG4gICAgICAgIH0pXG4gICAgfVxufVxuIl19