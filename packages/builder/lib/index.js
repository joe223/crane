"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validateBuildConfig = validateBuildConfig;
exports.resolvePath = resolvePath;
exports.createBuilderConfig = createBuilderConfig;
exports.builder = builder;

var _path = _interopRequireDefault(require("path"));

var _core = require("@cranejs/core");

var _shared = require("@cranejs/shared");

var _miniCssExtractPlugin = _interopRequireDefault(require("mini-css-extract-plugin"));

var _webpack = _interopRequireDefault(require("webpack"));

var _webpackDevServer = _interopRequireDefault(require("webpack-dev-server"));

var _webpackMerge = _interopRequireDefault(require("webpack-merge"));

var _copyWebpackPlugin = _interopRequireDefault(require("copy-webpack-plugin"));

var _htmlWebpackPlugin = _interopRequireDefault(require("html-webpack-plugin"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const cwd = process.cwd();

function validateBuildConfig(buildConfig, moduleName) {
  if (!buildConfig.entry && (!buildConfig.entries || buildConfig.entries.length === 0)) {
    _shared.logger.error(`module [${moduleName}] required a entry`);

    process.exit(1);
  }
}

function resolvePath(filePath) {
  return _path.default.isAbsolute(filePath) ? filePath : _path.default.join(cwd, './modules', filePath);
}

function createBuilderConfig(buildConfig, moduleName, clientEnv, buildType) {
  validateBuildConfig(buildConfig, moduleName);
  const conf = {
    entry: {},
    plugins: []
  };

  const configBuilder = require(`./webpackConfig/webpack.${buildType}.conf`);

  buildConfig.output = buildConfig.output || moduleName; // Single entry file

  if (buildConfig.entry) {
    const defaultEntryName = 'index';
    const entry = buildConfig;
    entry.templateParameters = {
      WEB_ENV: clientEnv,
      ...entry.templateParameters
    };
    conf.entry[defaultEntryName] = resolvePath(entry.entry);
    conf.plugins.push(genHtmlWebpackPluginConfig(buildType, entry, defaultEntryName, 'index.html')); // Multiple entry file
  } else {
    Object.keys(buildConfig.entries).forEach(entryName => {
      const entry = buildConfig.entries[entryName];
      entry.templateParameters = {
        WEB_ENV: clientEnv,
        ...entry.templateParameters
      };
      conf.entry[entryName] = resolvePath(entry.entry);
      conf.plugins.push(genHtmlWebpackPluginConfig(buildType, entry, entryName, entry.output || `${entryName}/index.html`));
    });
  }

  if (buildType === _shared.BuildType.prod) {
    conf.plugins.push(new _miniCssExtractPlugin.default({
      // Options similar to the same options in webpackOptions.output
      // both options are optional
      filename: buildType === _shared.BuildType.prod ? '[name].[chunkhash].css' : '[name].css',
      chunkFilename: buildType === _shared.BuildType.prod ? '[id].[chunkhash].css' : '[id].css'
    }));
  } // conf.plugins.push(...customPlugins.pluginsList)
  // Set public static assets
  // copy custom static assets


  if (buildConfig.static) {
    const staticAssets = [{
      from: resolvePath(buildConfig.static),
      to: _core.config.assetsSubDirectory,
      globOptions: {
        dot: false
      }
    }];
    conf.plugins.push(new _copyWebpackPlugin.default({
      patterns: staticAssets,
      options: {
        concurrency: 100
      }
    }));
  }

  const webpackConfig = (0, _webpackMerge.default)(configBuilder(buildConfig), {
    output: {
      path: _path.default.join(_core.config.assetsRoot, buildConfig.output),
      filename: '[name].[chunkhash].js',
      publicPath: _path.default.join(_path.default.sep, buildConfig.output, _path.default.sep)
    },
    plugins: [new _webpack.default.EnvironmentPlugin(clientEnv)]
  }, conf, buildConfig.webpack || {});
  return webpackConfig;
}

function builder(builderConfig, dev = false) {
  _shared.logger.debug(builderConfig);

  if (dev) {
    const options = _core.config.devServer;
    const server = new _webpackDevServer.default((0, _webpack.default)(builderConfig), options);
    server.listen(options.port, 'localhost', function (err) {
      if (err) {
        console.log(err);
      }

      console.log('WebpackDevServer listening at localhost:', options.port);
    });
  } else {
    const compiler = (0, _webpack.default)(builderConfig);
    compiler.run((err, stats) => console.log(err));
  }
}
/**
 * The default for options.templateParameter
 * Generate the template parameters
 */


function genTemplateParametersGenerator(entry) {
  return function templateParametersGenerator(compilation, assets, options) {
    // Try to use absolute path while loading stylesheet
    if (assets.extracted && assets.extracted.css) {
      assets.extracted.css.forEach(css => {
        if (!_path.default.isAbsolute(css.file) && css.file.indexOf(assets.publicPath) < 0) {
          css.file = _path.default.join(assets.publicPath, css.file);
        }
      });
    }

    return {
      title: entry.title || entry.templateParameters.title,
      ...entry.templateParameters,
      compilation,
      webpackConfig: entry.options,
      htmlWebpackPlugin: {
        files: assets,
        options: options
      }
    };
  };
}
/**
 * Factory function for generating HTMLWebpackPlugin instance
 * @param {string} buildType 'dev' | 'prod'
 * @param {{
 *  title,
 *  entry,
 *  output,
 *  template?,
 *  templateParameters?}} entry
 * @param entryName
 * @param {string} htmlFilename
 * @returns {HtmlWebpackPlugin}
 */


function genHtmlWebpackPluginConfig(buildType, entry, entryName, filename = 'index.html') {
  const template = entry.template ? resolvePath(entry.template) : _path.default.join(__dirname, '../template/index.pug');

  if (buildType === _shared.BuildType.dev) {
    return new _htmlWebpackPlugin.default({
      filename,
      template,
      inject: true,
      chunks: ['vendors', entryName],
      title: entry.title || entry.templateParameters.title,
      templateParameters: genTemplateParametersGenerator(entry)
    });
  } else {
    return new _htmlWebpackPlugin.default({
      filename,
      template,
      inject: true,
      chunks: ['vendors', entryName],
      title: entry.title || entry.templateParameters.title,
      templateParameters: genTemplateParametersGenerator(entry),
      minify: {
        removeComments: true,
        collapseWhitespace: true,
        removeAttributeQuotes: true // more options:
        // https://github.com/kangax/html-minifier#options-quick-reference

      },
      // necessary to consistently work with multiple chunks via CommonsChunkPlugin
      chunksSortMode: 'auto'
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjd2QiLCJwcm9jZXNzIiwidmFsaWRhdGVCdWlsZENvbmZpZyIsImJ1aWxkQ29uZmlnIiwibW9kdWxlTmFtZSIsImVudHJ5IiwiZW50cmllcyIsImxlbmd0aCIsImxvZ2dlciIsImVycm9yIiwiZXhpdCIsInJlc29sdmVQYXRoIiwiZmlsZVBhdGgiLCJwYXRoIiwiaXNBYnNvbHV0ZSIsImpvaW4iLCJjcmVhdGVCdWlsZGVyQ29uZmlnIiwiY2xpZW50RW52IiwiYnVpbGRUeXBlIiwiY29uZiIsInBsdWdpbnMiLCJjb25maWdCdWlsZGVyIiwicmVxdWlyZSIsIm91dHB1dCIsImRlZmF1bHRFbnRyeU5hbWUiLCJ0ZW1wbGF0ZVBhcmFtZXRlcnMiLCJXRUJfRU5WIiwicHVzaCIsImdlbkh0bWxXZWJwYWNrUGx1Z2luQ29uZmlnIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJlbnRyeU5hbWUiLCJCdWlsZFR5cGUiLCJwcm9kIiwiTWluaUNzc0V4dHJhY3RQbHVnaW4iLCJmaWxlbmFtZSIsImNodW5rRmlsZW5hbWUiLCJzdGF0aWMiLCJzdGF0aWNBc3NldHMiLCJmcm9tIiwidG8iLCJjb25maWciLCJhc3NldHNTdWJEaXJlY3RvcnkiLCJnbG9iT3B0aW9ucyIsImRvdCIsIkNvcHlXZWJwYWNrUGx1Z2luIiwicGF0dGVybnMiLCJvcHRpb25zIiwiY29uY3VycmVuY3kiLCJ3ZWJwYWNrQ29uZmlnIiwiYXNzZXRzUm9vdCIsInB1YmxpY1BhdGgiLCJzZXAiLCJ3ZWJwYWNrIiwiRW52aXJvbm1lbnRQbHVnaW4iLCJidWlsZGVyIiwiYnVpbGRlckNvbmZpZyIsImRldiIsImRlYnVnIiwiZGV2U2VydmVyIiwic2VydmVyIiwiV2VicGFja0RldlNlcnZlciIsImxpc3RlbiIsInBvcnQiLCJlcnIiLCJjb25zb2xlIiwibG9nIiwiY29tcGlsZXIiLCJydW4iLCJzdGF0cyIsImdlblRlbXBsYXRlUGFyYW1ldGVyc0dlbmVyYXRvciIsInRlbXBsYXRlUGFyYW1ldGVyc0dlbmVyYXRvciIsImNvbXBpbGF0aW9uIiwiYXNzZXRzIiwiZXh0cmFjdGVkIiwiY3NzIiwiZmlsZSIsImluZGV4T2YiLCJ0aXRsZSIsImh0bWxXZWJwYWNrUGx1Z2luIiwiZmlsZXMiLCJ0ZW1wbGF0ZSIsIl9fZGlybmFtZSIsIkh0bWxXZWJwYWNrUGx1Z2luIiwiaW5qZWN0IiwiY2h1bmtzIiwibWluaWZ5IiwicmVtb3ZlQ29tbWVudHMiLCJjb2xsYXBzZVdoaXRlc3BhY2UiLCJyZW1vdmVBdHRyaWJ1dGVRdW90ZXMiLCJjaHVua3NTb3J0TW9kZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsR0FBRyxHQUFHQyxPQUFPLENBQUNELEdBQVIsRUFBWjs7QUFFTyxTQUFTRSxtQkFBVCxDQUNIQyxXQURHLEVBRUhDLFVBRkcsRUFHTDtBQUNFLE1BQUksQ0FBQ0QsV0FBVyxDQUFDRSxLQUFiLEtBQ0ksQ0FBQ0YsV0FBVyxDQUFDRyxPQUFiLElBQXdCSCxXQUFXLENBQUNHLE9BQVosQ0FBb0JDLE1BQXBCLEtBQStCLENBRDNELENBQUosRUFFRTtBQUNFQyxtQkFBT0MsS0FBUCxDQUFjLFdBQVVMLFVBQVcsb0JBQW5DOztBQUNBSCxJQUFBQSxPQUFPLENBQUNTLElBQVIsQ0FBYSxDQUFiO0FBQ0g7QUFDSjs7QUFFTSxTQUFTQyxXQUFULENBQXNCQyxRQUF0QixFQUFnQztBQUNuQyxTQUFPQyxjQUFLQyxVQUFMLENBQWdCRixRQUFoQixJQUNEQSxRQURDLEdBRURDLGNBQUtFLElBQUwsQ0FBVWYsR0FBVixFQUFlLFdBQWYsRUFBNEJZLFFBQTVCLENBRk47QUFHSDs7QUFFTSxTQUFTSSxtQkFBVCxDQUNIYixXQURHLEVBRUhDLFVBRkcsRUFHSGEsU0FIRyxFQUlIQyxTQUpHLEVBS0w7QUFDRWhCLEVBQUFBLG1CQUFtQixDQUNmQyxXQURlLEVBRWZD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S3pCK0MsTUFBQUEsS0FBSyxFQUFFMUUsS0FBSyxDQUFDMEUsS0FBTixJQUFlMUUsS0FBSyxDQUFDb0Isa0JBQU4sQ0FBeUJzRCxLQUx0QjtBQU16QnRELE1BQUFBLGtCQUFrQixFQUFFOEMsOEJBQThCLENBQUNsRSxLQUFELENBTnpCO0FBT3pCa0YsTUFBQUEsTUFBTSxFQUFFO0FBQ0pDLFFBQUFBLGNBQWMsRUFBRSxJQURaO0FBRUpDLFFBQUFBLGtCQUFrQixFQUFFLElBRmhCO0FBR0pDLFFBQUFBLHFCQUFxQixFQUFFLElBSG5CLENBSUo7QUFDQTs7QUFMSSxPQVBpQjtBQWN6QjtBQUNBQyxNQUFBQSxjQUFjLEVBQUU7QUFmUyxLQUF0QixDQUFQO0FBaUJIO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHtcbiAgICBjb25maWdcbn0gZnJvbSAnQGNyYW5lanMvY29yZSdcbmltcG9ydCB7IGxvZ2dlciwgQnVpbGRUeXBlIH0gZnJvbSAnQGNyYW5lanMvc2hhcmVkJ1xuaW1wb3J0IE1pbmlDc3NFeHRyYWN0UGx1Z2luIGZyb20gJ21pbmktY3NzLWV4dHJhY3QtcGx1Z2luJ1xuaW1wb3J0IHdlYnBhY2sgZnJvbSAnd2VicGFjaydcbmltcG9ydCBXZWJwYWNrRGV2U2VydmVyIGZyb20gJ3dlYnBhY2stZGV2LXNlcnZlcidcbmltcG9ydCBtZXJnZSBmcm9tICd3ZWJwYWNrLW1lcmdlJ1xuaW1wb3J0IENvcHlXZWJwYWNrUGx1Z2luIGZyb20gJ2NvcHktd2VicGFjay1wbHVnaW4nXG5pbXBvcnQgSHRtbFdlYnBhY2tQbHVnaW4gZnJvbSAnaHRtbC13ZWJwYWNrLXBsdWdpbidcblxuY29uc3QgY3dkID0gcHJvY2Vzcy5jd2QoKVxuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVCdWlsZENvbmZpZyAoXG4gICAgYnVpbGRDb25maWcsXG4gICAgbW9kdWxlTmFtZVxuKSB7XG4gICAgaWYgKCFidWlsZENvbmZpZy5lbnRyeVxuICAgICAgICAmJiAoIWJ1aWxkQ29uZmlnLmVudHJpZXMgfHwgYnVpbGRDb25maWcuZW50cmllcy5sZW5ndGggPT09IDApXG4gICAgKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihgbW9kdWxlIFske21vZHVsZU5hbWV9XSByZXF1aXJlZCBhIGVudHJ5YClcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpXG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZVBhdGggKGZpbGVQYXRoKSB7XG4gICAgcmV0dXJuIHBhdGguaXNBYnNvbHV0ZShmaWxlUGF0aClcbiAgICAgICAgPyBmaWxlUGF0aFxuICAgICAgICA6IHBhdGguam9pbihjd2QsICcuL21vZHVsZXMnLCBmaWxlUGF0aClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUJ1aWxkZXJDb25maWcgKFxuICAgIGJ1aWxkQ29uZmlnLFxuICAgIG1vZHVsZU5hbWUsXG4gICAgY2xpZW50RW52LFxuICAgIGJ1aWxkVHlwZVxuKSB7XG4gICAgdmFsaWRhdGVCdWlsZENvbmZpZyhcbiAgICAgICAgYnVpbGRDb25maWcsXG4gICAgICAgIG1vZHVsZU5hbWVcbiAgICApXG5cbiAgICBjb25zdCBjb25mID0ge1xuICAgICAgICBlbnRyeToge30sXG4gICAgICAgIHBsdWdpbnM6IFtdXG4gICAgfVxuICAgIGNvbnN0IGNvbmZpZ0J1aWxkZXIgPSByZXF1aXJlKGAuL3dlYnBhY2tDb25maWcvd2VicGFjay4ke2J1aWxkVHlwZX0uY29uZmApXG5cbiAgICBidWlsZENvbmZpZy5vdXRwdXQgPSBidWlsZENvbmZpZy5vdXRwdXQgfHwgbW9kdWxlTmFtZVxuXG4gICAgLy8gU2luZ2xlIGVudHJ5IGZpbGVcbiAgICBpZiAoYnVpbGRDb25maWcuZW50cnkpIHtcbiAgICAgICAgY29uc3QgZGVmYXVsdEVudHJ5TmFtZSA9ICdpbmRleCdcbiAgICAgICAgY29uc3QgZW50cnkgPSBidWlsZENvbmZpZ1xuXG4gICAgICAgIGVudHJ5LnRlbXBsYXRlUGFyYW1ldGVycyA9IHtcbiAgICAgICAgICAgIFdFQl9FTlY6IGNsaWVudEVudixcbiAgICAgICAgICAgIC4uLmVudHJ5LnRlbXBsYXRlUGFyYW1ldGVyc1xuICAgICAgICB9XG5cbiAgICAgICAgY29uZi5lbnRyeVtkZWZhdWx0RW50cnlOYW1lXSA9IHJlc29sdmVQYXRoKGVudHJ5LmVudHJ5KVxuICAgICAgICBjb25mLnBsdWdpbnMucHVzaChnZW5IdG1sV2VicGFja1BsdWdpbkNvbmZpZyhcbiAgICAgICAgICAgIGJ1aWxkVHlwZSxcbiAgICAgICAgICAgIGVudHJ5LFxuICAgICAgICAgICAgZGVmYXVsdEVudHJ5TmFtZSxcbiAgICAgICAgICAgICdpbmRleC5odG1sJykpXG4gICAgLy8gTXVsdGlwbGUgZW50cnkgZmlsZVxuICAgIH0gZWxzZSB7XG4gICAgICAgIE9iamVjdC5rZXlzKGJ1aWxkQ29uZmlnLmVudHJpZXMpLmZvckVhY2goZW50cnlOYW1lID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gYnVpbGRDb25maWcuZW50cmllc1tlbnRyeU5hbWVdXG5cbiAgICAgICAgICAgIGVudHJ5LnRlbXBsYXRlUGFyYW1ldGVycyA9IHtcbiAgICAgICAgICAgICAgICBXRUJfRU5WOiBjbGllbnRFbnYsXG4gICAgICAgICAgICAgICAgLi4uZW50cnkudGVtcGxhdGVQYXJhbWV0ZXJzXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbmYuZW50cnlbZW50cnlOYW1lXSA9IHJlc29sdmVQYXRoKGVudHJ5LmVudHJ5KVxuICAgICAgICAgICAgY29uZi5wbHVnaW5zLnB1c2goZ2VuSHRtbFdlYnBhY2tQbHVnaW5Db25maWcoXG4gICAgICAgICAgICAgICAgYnVpbGRUeXBlLFxuICAgICAgICAgICAgICAgIGVudHJ5LFxuICAgICAgICAgICAgICAgIGVudHJ5TmFtZSxcbiAgICAgICAgICAgICAgICBlbnRyeS5vdXRwdXQgfHwgYCR7ZW50cnlOYW1lfS9pbmRleC5odG1sYCkpXG4gICAgICAgIH0pXG4gICAgfVxuICAgIGlmIChidWlsZFR5cGUgPT09IEJ1aWxkVHlwZS5wcm9kKSB7XG4gICAgICAgIGNvbmYucGx1Z2lucy5wdXNoKG5ldyBNaW5pQ3NzRXh0cmFjdFBsdWdpbih7XG4gICAgICAgICAgICAvLyBPcHRpb25zIHNpbWlsYXIgdG8gdGhlIHNhbWUgb3B0aW9ucyBpbiB3ZWJwYWNrT3B0aW9ucy5vdXRwdXRcbiAgICAgICAgICAgIC8vIGJvdGggb3B0aW9ucyBhcmUgb3B0aW9uYWxcbiAgICAgICAgICAgIGZpbGVuYW1lOiBidWlsZFR5cGUgPT09IEJ1aWxkVHlwZS5wcm9kID8gJ1tuYW1lXS5bY2h1bmtoYXNoXS5jc3MnIDogJ1tuYW1lXS5jc3MnLFxuICAgICAgICAgICAgY2h1bmtGaWxlbmFtZTogYnVpbGRUeXBlID09PSBCdWlsZFR5cGUucHJvZCA/ICdbaWRdLltjaHVua2hhc2hdLmNzcycgOiAnW2lkXS5jc3MnLFxuICAgICAgICB9KSlcbiAgICB9XG5cbiAgICAvLyBjb25mLnBsdWdpbnMucHVzaCguLi5jdXN0b21QbHVnaW5zLnBsdWdpbnNMaXN0KVxuXG5cbiAgICAvLyBTZXQgcHVibGljIHN0YXRpYyBhc3NldHNcbiAgICAvLyBjb3B5IGN1c3RvbSBzdGF0aWMgYXNzZXRzXG4gICAgaWYgKGJ1aWxkQ29uZmlnLnN0YXRpYykge1xuICAgICAgICBjb25zdCBzdGF0aWNBc3NldHMgPSBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZnJvbTogcmVzb2x2ZVBhdGgoYnVpbGRDb25maWcuc3RhdGljKSxcbiAgICAgICAgICAgICAgICB0bzogY29uZmlnLmFzc2V0c1N1YkRpcmVjdG9yeSxcbiAgICAgICAgICAgICAgICBnbG9iT3B0aW9uczoge1xuICAgICAgICAgICAgICAgICAgICBkb3Q6IGZhbHNlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBdXG5cbiAgICAgICAgY29uZi5wbHVnaW5zLnB1c2gobmV3IENvcHlXZWJwYWNrUGx1Z2luKHtcbiAgICAgICAgICAgIHBhdHRlcm5zOiBzdGF0aWNBc3NldHMsXG4gICAgICAgICAgICBvcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgY29uY3VycmVuY3k6IDEwMCxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkpXG4gICAgfVxuXG5cbiAgICBjb25zdCB3ZWJwYWNrQ29uZmlnID0gbWVyZ2UoY29uZmlnQnVpbGRlcihidWlsZENvbmZpZyksIHtcbiAgICAgICAgb3V0cHV0OiB7XG4gICAgICAgICAgICBwYXRoOiBwYXRoLmpvaW4oY29uZmlnLmFzc2V0c1Jvb3QsIGJ1aWxkQ29uZmlnLm91dHB1dCksXG4gICAgICAgICAgICBmaWxlbmFtZTogJ1tuYW1lXS5bY2h1bmtoYXNoXS5qcycsXG4gICAgICAgICAgICBwdWJsaWNQYXRoOiBwYXRoLmpvaW4ocGF0aC5zZXAsIGJ1aWxkQ29uZmlnLm91dHB1dCwgcGF0aC5zZXApXG4gICAgICAgIH0sXG4gICAgICAgIHBsdWdpbnM6IFtcbiAgICAgICAgICAgIG5ldyB3ZWJwYWNrLkVudmlyb25tZW50UGx1Z2luKGNsaWVudEVudilcbiAgICAgICAgXVxuICAgIH0sIGNvbmYsIGJ1aWxkQ29uZmlnLndlYnBhY2sgfHwge30pXG5cbiAgICByZXR1cm4gd2VicGFja0NvbmZpZ1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRlciAoYnVpbGRlckNvbmZpZywgZGV2ID0gZmFsc2UpIHtcbiAgICBsb2dnZXIuZGVidWcoYnVpbGRlckNvbmZpZylcbiAgICBpZiAoZGV2KSB7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb25maWcuZGV2U2VydmVyXG4gICAgICAgIGNvbnN0IHNlcnZlciA9IG5ldyBXZWJwYWNrRGV2U2VydmVyKHdlYnBhY2soYnVpbGRlckNvbmZpZyksIG9wdGlvbnMpXG5cbiAgICAgICAgc2VydmVyLmxpc3RlbihvcHRpb25zLnBvcnQsICdsb2NhbGhvc3QnLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdXZWJwYWNrRGV2U2VydmVyIGxpc3RlbmluZyBhdCBsb2NhbGhvc3Q6Jywgb3B0aW9ucy5wb3J0KTtcbiAgICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBjb21waWxlciA9IHdlYnBhY2soYnVpbGRlckNvbmZpZylcblxuICAgICAgICBjb21waWxlci5ydW4oKGVyciwgc3RhdHMpID0+IGNvbnNvbGUubG9nKGVycikpXG4gICAgfVxufVxuXG4vKipcbiAqIFRoZSBkZWZhdWx0IGZvciBvcHRpb25zLnRlbXBsYXRlUGFyYW1ldGVyXG4gKiBHZW5lcmF0ZSB0aGUgdGVtcGxhdGUgcGFyYW1ldGVyc1xuICovXG5mdW5jdGlvbiBnZW5UZW1wbGF0ZVBhcmFtZXRlcnNHZW5lcmF0b3IgKGVudHJ5KSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIHRlbXBsYXRlUGFyYW1ldGVyc0dlbmVyYXRvciAoXG4gICAgICAgIGNvbXBpbGF0aW9uLFxuICAgICAgICBhc3NldHMsXG4gICAgICAgIG9wdGlvbnNcbiAgICApIHtcblxuICAgICAgICAvLyBUcnkgdG8gdXNlIGFic29sdXRlIHBhdGggd2hpbGUgbG9hZGluZyBzdHlsZXNoZWV0XG4gICAgICAgIGlmIChhc3NldHMuZXh0cmFjdGVkICYmIGFzc2V0cy5leHRyYWN0ZWQuY3NzKSB7XG4gICAgICAgICAgICBhc3NldHMuZXh0cmFjdGVkLmNzcy5mb3JFYWNoKChjc3MpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXBhdGguaXNBYnNvbHV0ZShjc3MuZmlsZSkgJiYgY3NzLmZpbGUuaW5kZXhPZihhc3NldHMucHVibGljUGF0aCkgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNzcy5maWxlID0gcGF0aC5qb2luKGFzc2V0cy5wdWJsaWNQYXRoLCBjc3MuZmlsZSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0aXRsZTogZW50cnkudGl0bGUgfHwgZW50cnkudGVtcGxhdGVQYXJhbWV0ZXJzLnRpdGxlLFxuICAgICAgICAgICAgLi4uZW50cnkudGVtcGxhdGVQYXJhbWV0ZXJzLFxuICAgICAgICAgICAgY29tcGlsYXRpb24sXG4gICAgICAgICAgICB3ZWJwYWNrQ29uZmlnOiBlbnRyeS5vcHRpb25zLFxuICAgICAgICAgICAgaHRtbFdlYnBhY2tQbHVnaW46IHtcbiAgICAgICAgICAgICAgICBmaWxlczogYXNzZXRzLFxuICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnNcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuXG4vKipcbiAqIEZhY3RvcnkgZnVuY3Rpb24gZm9yIGdlbmVyYXRpbmcgSFRNTFdlYnBhY2tQbHVnaW4gaW5zdGFuY2VcbiAqIEBwYXJhbSB7c3RyaW5nfSBidWlsZFR5cGUgJ2RldicgfCAncHJvZCdcbiAqIEBwYXJhbSB7e1xuICogIHRpdGxlLFxuICogIGVudHJ5LFxuICogIG91dHB1dCxcbiAqICB0ZW1wbGF0ZT8sXG4gKiAgdGVtcGxhdGVQYXJhbWV0ZXJzP319IGVudHJ5XG4gKiBAcGFyYW0gZW50cnlOYW1lXG4gKiBAcGFyYW0ge3N0cmluZ30gaHRtbEZpbGVuYW1lXG4gKiBAcmV0dXJucyB7SHRtbFdlYnBhY2tQbHVnaW59XG4gKi9cbmZ1bmN0aW9uIGdlbkh0bWxXZWJwYWNrUGx1Z2luQ29uZmlnIChcbiAgICBidWlsZFR5cGUsXG4gICAgZW50cnksXG4gICAgZW50cnlOYW1lLFxuICAgIGZpbGVuYW1lID0gJ2luZGV4Lmh0bWwnXG4pIHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGVudHJ5LnRlbXBsYXRlXG4gICAgICAgID8gcmVzb2x2ZVBhdGgoZW50cnkudGVtcGxhdGUpXG4gICAgICAgIDogcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3RlbXBsYXRlL2luZGV4LnB1ZycpXG5cbiAgICBpZiAoYnVpbGRUeXBlID09PSBCdWlsZFR5cGUuZGV2KSB7XG4gICAgICAgIHJldHVybiBuZXcgSHRtbFdlYnBhY2tQbHVnaW4oe1xuICAgICAgICAgICAgZmlsZW5hbWUsXG4gICAgICAgICAgICB0ZW1wbGF0ZSxcbiAgICAgICAgICAgIGluamVjdDogdHJ1ZSxcbiAgICAgICAgICAgIGNodW5rczogWyd2ZW5kb3JzJywgZW50cnlOYW1lXSxcbiAgICAgICAgICAgIHRpdGxlOiBlbnRyeS50aXRsZSB8fCBlbnRyeS50ZW1wbGF0ZVBhcmFtZXRlcnMudGl0bGUsXG4gICAgICAgICAgICB0ZW1wbGF0ZVBhcmFtZXRlcnM6IGdlblRlbXBsYXRlUGFyYW1ldGVyc0dlbmVyYXRvcihlbnRyeSlcbiAgICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gbmV3IEh0bWxXZWJwYWNrUGx1Z2luKHtcbiAgICAgICAgICAgIGZpbGVuYW1lLFxuICAgICAgICAgICAgdGVtcGxhdGUsXG4gICAgICAgICAgICBpbmplY3Q6IHRydWUsXG4gICAgICAgICAgICBjaHVua3M6IFsndmVuZG9ycycsIGVudHJ5TmFtZV0sXG4gICAgICAgICAgICB0aXRsZTogZW50cnkudGl0bGUgfHwgZW50cnkudGVtcGxhdGVQYXJhbWV0ZXJzLnRpdGxlLFxuICAgICAgICAgICAgdGVtcGxhdGVQYXJhbWV0ZXJzOiBnZW5UZW1wbGF0ZVBhcmFtZXRlcnNHZW5lcmF0b3IoZW50cnkpLFxuICAgICAgICAgICAgbWluaWZ5OiB7XG4gICAgICAgICAgICAgICAgcmVtb3ZlQ29tbWVudHM6IHRydWUsXG4gICAgICAgICAgICAgICAgY29sbGFwc2VXaGl0ZXNwYWNlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJlbW92ZUF0dHJpYnV0ZVF1b3RlczogdHJ1ZVxuICAgICAgICAgICAgICAgIC8vIG1vcmUgb3B0aW9uczpcbiAgICAgICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20va2FuZ2F4L2h0bWwtbWluaWZpZXIjb3B0aW9ucy1xdWljay1yZWZlcmVuY2VcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvLyBuZWNlc3NhcnkgdG8gY29uc2lzdGVudGx5IHdvcmsgd2l0aCBtdWx0aXBsZSBjaHVua3MgdmlhIENvbW1vbnNDaHVua1BsdWdpblxuICAgICAgICAgICAgY2h1bmtzU29ydE1vZGU6ICdhdXRvJ1xuICAgICAgICB9KVxuICAgIH1cbn1cbiJdfQ==