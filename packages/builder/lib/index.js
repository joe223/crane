"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validateBuildConfig = validateBuildConfig;
exports.resolvePath = resolvePath;
exports.createBuilderConfig = createBuilderConfig;
exports.builder = builder;

var _path = _interopRequireDefault(require("path"));

var _shared = require("@cranejs/shared");

var _miniCssExtractPlugin = _interopRequireDefault(require("mini-css-extract-plugin"));

var _webpack = _interopRequireDefault(require("webpack"));

var _webpackDevServer = _interopRequireDefault(require("webpack-dev-server"));

var _webpackMerge = _interopRequireDefault(require("webpack-merge"));

var _copyWebpackPlugin = _interopRequireDefault(require("copy-webpack-plugin"));

var _htmlWebpackPlugin = _interopRequireDefault(require("html-webpack-plugin"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const cwd = process.cwd();

function loadPlugin(name) {
  return require(require.resolve(name, {
    paths: [cwd, __dirname, _path.default.resolve(__dirname, '../')]
  })).default;
}

function validateBuildConfig(buildConfig, moduleName) {
  if (!buildConfig.entry && (!buildConfig.entries || buildConfig.entries.length === 0)) {
    _shared.logger.error(`module [${moduleName}] required a entry`);

    process.exit(1);
  }
}

function resolvePath(filePath) {
  return _path.default.isAbsolute(filePath) ? filePath : _path.default.join(cwd, './modules', filePath);
}

function createBuilderConfig(pageConfig, moduleName, clientEnv, buildType) {
  const configBuilder = require(`./webpackConfig/webpack.${buildType}.conf`).default(pageConfig);

  const baseOutput = pageConfig.output || moduleName;
  validateBuildConfig(pageConfig, moduleName);

  _shared.config.plugins.forEach(plugin => {
    let [resolvedPlugin, options] = typeof plugin === 'string' // string
    ? [loadPlugin(plugin)] // [plugin, option]
    : Array.isArray(plugin) ? typeof plugin[0] === 'function' ? [plugin[0], plugin[1]] : [loadPlugin(plugin[0]), plugin[1]] : // function
    [plugin];
    resolvedPlugin({
      configBuilder,
      pageConfig,
      moduleName,
      clientEnv,
      buildType
    }, options);
  });

  const baseConfig = configBuilder.toConfig();
  const extendConfig = {
    entry: {},
    plugins: []
  }; // Single entry file

  if (pageConfig.entry) {
    const entry = pageConfig;
    const defaultEntryName = 'index';
    entry.templateParameters = {
      WEB_ENV: clientEnv,
      ...entry.templateParameters
    };
    extendConfig.entry[defaultEntryName] = resolvePath(entry.entry);
    extendConfig.plugins.push(genHtmlWebpackPluginConfig(buildType, entry, defaultEntryName, 'index.html')); // Multiple entry file
  } else {
    Object.keys(pageConfig.entries).forEach(entryName => {
      const entry = pageConfig.entries[entryName];
      entry.templateParameters = {
        WEB_ENV: clientEnv,
        ...entry.templateParameters
      };
      extendConfig.entry[entryName] = resolvePath(entry.entry);
      extendConfig.plugins.push(genHtmlWebpackPluginConfig(buildType, entry, entryName, entry.output || _path.default.join(entryName, 'index.html')));
    });
  }

  if (buildType === _shared.BuildType.prod) {
    extendConfig.plugins.push(new _miniCssExtractPlugin.default({
      // Options similar to the same options in webpackOptions.output
      // both options are optional
      filename: '[name].[chunkhash].css',
      chunkFilename: '[id].[chunkhash].css'
    }));
  } // Set public static assets
  // copy custom static assets


  if (pageConfig.static) {
    const staticAssets = [{
      from: resolvePath(pageConfig.static),
      to: _shared.config.assetsSubDirectory,
      globOptions: {
        dot: false
      }
    }];
    extendConfig.plugins.push(new _copyWebpackPlugin.default({
      patterns: staticAssets,
      options: {
        concurrency: 100
      }
    }));
  }

  const webpackConfig = (0, _webpackMerge.default)(baseConfig, {
    output: {
      path: _path.default.join(_shared.config.assetsRoot, baseOutput),
      filename: '[name].[chunkhash].js',
      publicPath: _path.default.join(_path.default.sep, baseOutput, _path.default.sep)
    },
    plugins: [new _webpack.default.EnvironmentPlugin(clientEnv)]
  }, extendConfig, pageConfig.webpack || {});
  return webpackConfig;
}

function builder(builderConfig, dev = false) {
  if (dev) {
    const options = _shared.config.devServer;
    const server = new _webpackDevServer.default((0, _webpack.default)(builderConfig), options);
    server.listen(options.port, 'localhost', function (err) {
      if (err) {
        console.log(err);
      }

      console.log('WebpackDevServer listening at localhost:', options.port);
    });
  } else {
    (0, _webpack.default)(builderConfig, (err, stats) => {
      // https://webpack.js.org/api/node/#error-handling
      if (err) {
        console.error(err.stack || err);

        if (err.details) {
          console.error(err.details);
        }

        return;
      }

      const info = stats.toJson();

      if (stats.hasErrors()) {
        console.error(info.errors);
      }

      if (stats.hasWarnings()) {
        console.warn(info.warnings);
      }
    });
  }
}
/**
 * The default for options.templateParameter
 * Generate the template parameters
 */


function genTemplateParametersGenerator(entry) {
  return function templateParametersGenerator(compilation, assets, options) {
    // Try to use absolute path while loading stylesheet
    if (assets.extracted && assets.extracted.css) {
      assets.extracted.css.forEach(css => {
        if (!_path.default.isAbsolute(css.file) && css.file.indexOf(assets.publicPath) < 0) {
          css.file = _path.default.join(assets.publicPath, css.file);
        }
      });
    }

    return {
      title: entry.title || entry.templateParameters.title,
      ...entry.templateParameters,
      compilation,
      webpackConfig: entry.options,
      htmlWebpackPlugin: {
        files: assets,
        options: options
      }
    };
  };
}
/**
 * Factory function for generating HTMLWebpackPlugin instance
 * @param {string} buildType 'dev' | 'prod'
 * @param {{
 *  title,
 *  entry,
 *  output,
 *  template?,
 *  templateParameters?}} entry
 * @param entryName
 * @param {string} htmlFilename
 * @returns {HtmlWebpackPlugin}
 */


function genHtmlWebpackPluginConfig(buildType, entry, entryName, filename = 'index.html') {
  const template = entry.template ? resolvePath(entry.template) : _shared.config.defaultTemplate;

  if (buildType === _shared.BuildType.dev) {
    return new _htmlWebpackPlugin.default({
      filename,
      template,
      inject: true,
      chunks: ['vendors', entryName],
      title: entry.title || entry.templateParameters.title,
      templateParameters: genTemplateParametersGenerator(entry)
    });
  } else {
    return new _htmlWebpackPlugin.default({
      filename,
      template,
      inject: true,
      chunks: ['vendors', entryName],
      title: entry.title || entry.templateParameters.title,
      templateParameters: genTemplateParametersGenerator(entry),
      minify: {
        removeComments: true,
        collapseWhitespace: true,
        removeAttributeQuotes: true // more options:
        // https://github.com/kangax/html-minifier#options-quick-reference

      },
      // necessary to consistently work with multiple chunks via CommonsChunkPlugin
      chunksSortMode: 'auto'
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjd2QiLCJwcm9jZXNzIiwibG9hZFBsdWdpbiIsIm5hbWUiLCJyZXF1aXJlIiwicmVzb2x2ZSIsInBhdGhzIiwiX19kaXJuYW1lIiwicGF0aCIsImRlZmF1bHQiLCJ2YWxpZGF0ZUJ1aWxkQ29uZmlnIiwiYnVpbGRDb25maWciLCJtb2R1bGVOYW1lIiwiZW50cnkiLCJlbnRyaWVzIiwibGVuZ3RoIiwibG9nZ2VyIiwiZXJyb3IiLCJleGl0IiwicmVzb2x2ZVBhdGgiLCJmaWxlUGF0aCIsImlzQWJzb2x1dGUiLCJqb2luIiwiY3JlYXRlQnVpbGRlckNvbmZpZyIsInBhZ2VDb25maWciLCJjbGllbnRFbnYiLCJidWlsZFR5cGUiLCJjb25maWdCdWlsZGVyIiwiYmFzZU91dHB1dCIsIm91dHB1dCIsImNvbmZpZyIsInBsdWdpbnMiLCJmb3JFYWNoIiwicGx1Z2luIiwicmVzb2x2ZWRQbHVnaW4iLCJvcHRpb25zIiwiQXJyYXkiLCJpc0FycmF5IiwiYmFzZUNvbmZpZyIsInRvQ29uZmlnIiwiZXh0ZW5kQ29uZmlnIiwiZGVmYXVsdEVudHJ5TmFtZSIsInRlbXBsYXRlUGFyYW1ldGVycyIsIldFQl9FTlYiLCJwdXNoIiwiZ2VuSHRtbFdlYnBhY2tQbHVnaW5Db25maWciLCJPYmplY3QiLCJrZXlzIiwiZW50cnlOYW1lIiwiQnVpbGRUeXBlIiwicHJvZCIsIk1pbmlDc3NFeHRyYWN0UGx1Z2luIiwiZmlsZW5hbWUiLCJjaHVua0ZpbGVuYW1lIiwic3RhdGljIiwic3RhdGljQXNzZXRzIiwiZnJvbSIsInRvIiwiYXNzZXRzU3ViRGlyZWN0b3J5IiwiZ2xvYk9wdGlvbnMiLCJkb3QiLCJDb3B5V2VicGFja1BsdWdpbiIsInBhdHRlcm5zIiwiY29uY3VycmVuY3kiLCJ3ZWJwYWNrQ29uZmlnIiwiYXNzZXRzUm9vdCIsInB1YmxpY1BhdGgiLCJzZXAiLCJ3ZWJwYWNrIiwiRW52aXJvbm1lbnRQbHVnaW4iLCJidWlsZGVyIiwiYnVpbGRlckNvbmZpZyIsImRldiIsImRldlNlcnZlciIsInNlcnZlciIsIldlYnBhY2tEZXZTZXJ2ZXIiLCJsaXN0ZW4iLCJwb3J0IiwiZXJyIiwiY29uc29sZSIsImxvZyIsInN0YXRzIiwic3RhY2siLCJkZXRhaWxzIiwiaW5mbyIsInRvSnNvbiIsImhhc0Vycm9ycyIsImVycm9ycyIsImhhc1dhcm5pbmdzIiwid2FybiIsIndhcm5pbmdzIiwiZ2VuVGVtcGxhdGVQYXJhbWV0ZXJzR2VuZXJhdG9yIiwidGVtcGxhdGVQYXJhbWV0ZXJzR2VuZXJhdG9yIiwiY29tcGlsYXRpb24iLCJhc3NldHMiLCJleHRyYWN0ZWQiLCJjc3MiLCJmaWxlIiwiaW5kZXhPZiIsInRpdGxlIiwiaHRtbFdlYnBhY2tQbHVnaW4iLCJmaWxlcyIsInRlbXBsYXRlIiwiZGVmYXVsdFRlbXBsYXRlIiwiSHRtbFdlYnBhY2tQbHVnaW4iLCJpbmplY3QiLCJjaHVua3MiLCJtaW5pZnkiLCJyZW1vdmVDb21tZW50cyIsImNvbGxhcHNlV2hpdGVzcGFjZSIsInJlbW92ZUF0dHJpYnV0ZVF1b3RlcyIsImNodW5rc1NvcnRNb2RlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxHQUFHLEdBQUdDLE9BQU8sQ0FBQ0QsR0FBUixFQUFaOztBQUVBLFNBQVNFLFVBQVQsQ0FBcUJDLElBQXJCLEVBQTJCO0FBQ3ZCLFNBQU9DLE9BQU8sQ0FBQ0EsT0FBTyxDQUFDQyxPQUFSLENBQWdCRixJQUFoQixFQUFzQjtBQUNqQ0csSUFBQUEsS0FBSyxFQUFFLENBQ0hOLEdBREcsRUFFSE8sU0FGRyxFQUdIQyxjQUFLSCxPQUFMLENBQWFFLFNBQWIsRUFBd0IsS0FBeEIsQ0FIRztBQUQwQixHQUF0QixDQUFELENBQVAsQ0FNSEUsT0FOSjtBQU9IOztBQUVNLFNBQVNDLG1CQUFULENBQTZCQyxXQUE3QixFQUEwQ0MsVUFBMUMsRUFBc0Q7QUFD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LE1BQUFBLFFBRnlCO0FBR3pCRyxNQUFBQSxNQUFNLEVBQUUsSUFIaUI7QUFJekJDLE1BQUFBLE1BQU0sRUFBRSxDQUFDLFNBQUQsRUFBWTFELFNBQVosQ0FKaUI7QUFLekJtRCxNQUFBQSxLQUFLLEVBQUV0RixLQUFLLENBQUNzRixLQUFOLElBQWV0RixLQUFLLENBQUM2QixrQkFBTixDQUF5QnlELEtBTHRCO0FBTXpCekQsTUFBQUEsa0JBQWtCLEVBQUVpRCw4QkFBOEIsQ0FBQzlFLEtBQUQ7QUFOekIsS0FBdEIsQ0FBUDtBQVFILEdBVEQsTUFTTztBQUNILFdBQU8sSUFBSTJGLDBCQUFKLENBQXNCO0FBQ3pCcEQsTUFBQUEsUUFEeUI7QUFFekJrRCxNQUFBQSxRQUZ5QjtBQUd6QkcsTUFBQUEsTUFBTSxFQUFFLElBSGlCO0FBSXpCQyxNQUFBQSxNQUFNLEVBQUUsQ0FBQyxTQUFELEVBQVkxRCxTQUFaLENBSmlCO0FBS3pCbUQsTUFBQUEsS0FBSyxFQUFFdEYsS0FBSyxDQUFDc0YsS0FBTixJQUFldEYsS0FBSyxDQUFDNkIsa0JBQU4sQ0FBeUJ5RCxLQUx0QjtBQU16QnpELE1BQUFBLGtCQUFrQixFQUFFaUQsOEJBQThCLENBQUM5RSxLQUFELENBTnpCO0FBT3pCOEYsTUFBQUEsTUFBTSxFQUFFO0FBQ0pDLFFBQUFBLGNBQWMsRUFBRSxJQURaO0FBRUpDLFFBQUFBLGtCQUFrQixFQUFFLElBRmhCO0FBR0pDLFFBQUFBLHFCQUFxQixFQUFFLElBSG5CLENBSUo7QUFDQTs7QUFMSSxPQVBpQjtBQWN6QjtBQUNBQyxNQUFBQSxjQUFjLEVBQUU7QUFmUyxLQUF0QixDQUFQO0FBaUJIO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHsgY29uZmlnLCBsb2dnZXIsIEJ1aWxkVHlwZSB9IGZyb20gJ0BjcmFuZWpzL3NoYXJlZCdcbmltcG9ydCBNaW5pQ3NzRXh0cmFjdFBsdWdpbiBmcm9tICdtaW5pLWNzcy1leHRyYWN0LXBsdWdpbidcbmltcG9ydCB3ZWJwYWNrIGZyb20gJ3dlYnBhY2snXG5pbXBvcnQgV2VicGFja0RldlNlcnZlciBmcm9tICd3ZWJwYWNrLWRldi1zZXJ2ZXInXG5pbXBvcnQgbWVyZ2UgZnJvbSAnd2VicGFjay1tZXJnZSdcbmltcG9ydCBDb3B5V2VicGFja1BsdWdpbiBmcm9tICdjb3B5LXdlYnBhY2stcGx1Z2luJ1xuaW1wb3J0IEh0bWxXZWJwYWNrUGx1Z2luIGZyb20gJ2h0bWwtd2VicGFjay1wbHVnaW4nXG5cbmNvbnN0IGN3ZCA9IHByb2Nlc3MuY3dkKClcblxuZnVuY3Rpb24gbG9hZFBsdWdpbiAobmFtZSkge1xuICAgIHJldHVybiByZXF1aXJlKHJlcXVpcmUucmVzb2x2ZShuYW1lLCB7XG4gICAgICAgIHBhdGhzOiBbXG4gICAgICAgICAgICBjd2QsXG4gICAgICAgICAgICBfX2Rpcm5hbWUsXG4gICAgICAgICAgICBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vJylcbiAgICAgICAgXVxuICAgIH0pKS5kZWZhdWx0XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZUJ1aWxkQ29uZmlnKGJ1aWxkQ29uZmlnLCBtb2R1bGVOYW1lKSB7XG4gICAgaWYgKFxuICAgICAgICAhYnVpbGRDb25maWcuZW50cnkgJiZcbiAgICAgICAgKCFidWlsZENvbmZpZy5lbnRyaWVzIHx8IGJ1aWxkQ29uZmlnLmVudHJpZXMubGVuZ3RoID09PSAwKVxuICAgICkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoYG1vZHVsZSBbJHttb2R1bGVOYW1lfV0gcmVxdWlyZWQgYSBlbnRyeWApXG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKVxuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlc29sdmVQYXRoKGZpbGVQYXRoKSB7XG4gICAgcmV0dXJuIHBhdGguaXNBYnNvbHV0ZShmaWxlUGF0aClcbiAgICAgICAgPyBmaWxlUGF0aFxuICAgICAgICA6IHBhdGguam9pbihjd2QsICcuL21vZHVsZXMnLCBmaWxlUGF0aClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUJ1aWxkZXJDb25maWcoXG4gICAgcGFnZUNvbmZpZyxcbiAgICBtb2R1bGVOYW1lLFxuICAgIGNsaWVudEVudixcbiAgICBidWlsZFR5cGVcbikge1xuICAgIGNvbnN0IGNvbmZpZ0J1aWxkZXIgPSByZXF1aXJlKGAuL3dlYnBhY2tDb25maWcvd2VicGFjay4ke2J1aWxkVHlwZX0uY29uZmApLmRlZmF1bHQocGFnZUNvbmZpZylcbiAgICBjb25zdCBiYXNlT3V0cHV0ID0gcGFnZUNvbmZpZy5vdXRwdXQgfHwgbW9kdWxlTmFtZVxuXG4gICAgdmFsaWRhdGVCdWlsZENvbmZpZyhwYWdlQ29uZmlnLCBtb2R1bGVOYW1lKVxuXG4gICAgY29uZmlnLnBsdWdpbnMuZm9yRWFjaChwbHVnaW4gPT4ge1xuICAgICAgICBsZXQgW3Jlc29sdmVkUGx1Z2luLCBvcHRpb25zXSA9IHR5cGVvZiBwbHVnaW4gPT09ICdzdHJpbmcnXG4gICAgICAgICAgICAvLyBzdHJpbmdcbiAgICAgICAgICAgID8gW2xvYWRQbHVnaW4ocGx1Z2luKV1cbiAgICAgICAgICAgIC8vIFtwbHVnaW4sIG9wdGlvbl1cbiAgICAgICAgICAgIDogKFxuICAgICAgICAgICAgICAgIEFycmF5LmlzQXJyYXkocGx1Z2luKVxuICAgICAgICAgICAgICAgID8gKHR5cGVvZiBwbHVnaW5bMF0gPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgICAgICAgICAgPyBbcGx1Z2luWzBdLCBwbHVnaW5bMV1dXG4gICAgICAgICAgICAgICAgICAgIDogW2xvYWRQbHVnaW4ocGx1Z2luWzBdKSwgcGx1Z2luWzFdXSlcbiAgICAgICAgICAgICAgICAvLyBmdW5jdGlvblxuICAgICAgICAgICAgICAgIDogW3BsdWdpbl1cbiAgICAgICAgICAgIClcblxuICAgICAgICByZXNvbHZlZFBsdWdpbih7XG4gICAgICAgICAgICBjb25maWdCdWlsZGVyLFxuICAgICAgICAgICAgcGFnZUNvbmZpZyxcbiAgICAgICAgICAgIG1vZHVsZU5hbWUsXG4gICAgICAgICAgICBjbGllbnRFbnYsXG4gICAgICAgICAgICBidWlsZFR5cGVcbiAgICAgICAgfSwgb3B0aW9ucylcbiAgICB9KVxuXG4gICAgY29uc3QgYmFzZUNvbmZpZyA9IGNvbmZpZ0J1aWxkZXIudG9Db25maWcoKVxuICAgIGNvbnN0IGV4dGVuZENvbmZpZyA9IHtcbiAgICAgICAgZW50cnk6IHt9LFxuICAgICAgICBwbHVnaW5zOiBbXSxcbiAgICB9XG5cbiAgICAvLyBTaW5nbGUgZW50cnkgZmlsZVxuICAgIGlmIChwYWdlQ29uZmlnLmVudHJ5KSB7XG4gICAgICAgIGNvbnN0IGVudHJ5ID0gcGFnZUNvbmZpZ1xuICAgICAgICBjb25zdCBkZWZhdWx0RW50cnlOYW1lID0gJ2luZGV4J1xuXG4gICAgICAgIGVudHJ5LnRlbXBsYXRlUGFyYW1ldGVycyA9IHtcbiAgICAgICAgICAgIFdFQl9FTlY6IGNsaWVudEVudixcbiAgICAgICAgICAgIC4uLmVudHJ5LnRlbXBsYXRlUGFyYW1ldGVycyxcbiAgICAgICAgfVxuXG4gICAgICAgIGV4dGVuZENvbmZpZy5lbnRyeVtkZWZhdWx0RW50cnlOYW1lXSA9IHJlc29sdmVQYXRoKGVudHJ5LmVudHJ5KVxuICAgICAgICBleHRlbmRDb25maWcucGx1Z2lucy5wdXNoKFxuICAgICAgICAgICAgZ2VuSHRtbFdlYnBhY2tQbHVnaW5Db25maWcoXG4gICAgICAgICAgICAgICAgYnVpbGRUeXBlLFxuICAgICAgICAgICAgICAgIGVudHJ5LFxuICAgICAgICAgICAgICAgIGRlZmF1bHRFbnRyeU5hbWUsXG4gICAgICAgICAgICAgICAgJ2luZGV4Lmh0bWwnXG4gICAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICAgLy8gTXVsdGlwbGUgZW50cnkgZmlsZVxuICAgIH0gZWxzZSB7XG4gICAgICAgIE9iamVjdC5rZXlzKHBhZ2VDb25maWcuZW50cmllcykuZm9yRWFjaCgoZW50cnlOYW1lKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlbnRyeSA9IHBhZ2VDb25maWcuZW50cmllc1tlbnRyeU5hbWVdXG5cbiAgICAgICAgICAgIGVudHJ5LnRlbXBsYXRlUGFyYW1ldGVycyA9IHtcbiAgICAgICAgICAgICAgICBXRUJfRU5WOiBjbGllbnRFbnYsXG4gICAgICAgICAgICAgICAgLi4uZW50cnkudGVtcGxhdGVQYXJhbWV0ZXJzLFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBleHRlbmRDb25maWcuZW50cnlbZW50cnlOYW1lXSA9IHJlc29sdmVQYXRoKGVudHJ5LmVudHJ5KVxuICAgICAgICAgICAgZXh0ZW5kQ29uZmlnLnBsdWdpbnMucHVzaChcbiAgICAgICAgICAgICAgICBnZW5IdG1sV2VicGFja1BsdWdpbkNvbmZpZyhcbiAgICAgICAgICAgICAgICAgICAgYnVpbGRUeXBlLFxuICAgICAgICAgICAgICAgICAgICBlbnRyeSxcbiAgICAgICAgICAgICAgICAgICAgZW50cnlOYW1lLFxuICAgICAgICAgICAgICAgICAgICBlbnRyeS5vdXRwdXQgfHwgcGF0aC5qb2luKGVudHJ5TmFtZSwgJ2luZGV4Lmh0bWwnKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBpZiAoYnVpbGRUeXBlID09PSBCdWlsZFR5cGUucHJvZCkge1xuICAgICAgICBleHRlbmRDb25maWcucGx1Z2lucy5wdXNoKFxuICAgICAgICAgICAgbmV3IE1pbmlDc3NFeHRyYWN0UGx1Z2luKHtcbiAgICAgICAgICAgICAgICAvLyBPcHRpb25zIHNpbWlsYXIgdG8gdGhlIHNhbWUgb3B0aW9ucyBpbiB3ZWJwYWNrT3B0aW9ucy5vdXRwdXRcbiAgICAgICAgICAgICAgICAvLyBib3RoIG9wdGlvbnMgYXJlIG9wdGlvbmFsXG4gICAgICAgICAgICAgICAgZmlsZW5hbWU6ICdbbmFtZV0uW2NodW5raGFzaF0uY3NzJyxcbiAgICAgICAgICAgICAgICBjaHVua0ZpbGVuYW1lOiAnW2lkXS5bY2h1bmtoYXNoXS5jc3MnXG4gICAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgfVxuXG5cbiAgICAvLyBTZXQgcHVibGljIHN0YXRpYyBhc3NldHNcbiAgICAvLyBjb3B5IGN1c3RvbSBzdGF0aWMgYXNzZXRzXG4gICAgaWYgKHBhZ2VDb25maWcuc3RhdGljKSB7XG4gICAgICAgIGNvbnN0IHN0YXRpY0Fzc2V0cyA9IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBmcm9tOiByZXNvbHZlUGF0aChwYWdlQ29uZmlnLnN0YXRpYyksXG4gICAgICAgICAgICAgICAgdG86IGNvbmZpZy5hc3NldHNTdWJEaXJlY3RvcnksXG4gICAgICAgICAgICAgICAgZ2xvYk9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICAgICAgZG90OiBmYWxzZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgXVxuXG4gICAgICAgIGV4dGVuZENvbmZpZy5wbHVnaW5zLnB1c2goXG4gICAgICAgICAgICBuZXcgQ29weVdlYnBhY2tQbHVnaW4oe1xuICAgICAgICAgICAgICAgIHBhdHRlcm5zOiBzdGF0aWNBc3NldHMsXG4gICAgICAgICAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgICAgICAgICAgICBjb25jdXJyZW5jeTogMTAwLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgfVxuXG4gICAgY29uc3Qgd2VicGFja0NvbmZpZyA9IG1lcmdlKFxuICAgICAgICBiYXNlQ29uZmlnLFxuICAgICAgICB7XG4gICAgICAgICAgICBvdXRwdXQ6IHtcbiAgICAgICAgICAgICAgICBwYXRoOiBwYXRoLmpvaW4oY29uZmlnLmFzc2V0c1Jvb3QsIGJhc2VPdXRwdXQpLFxuICAgICAgICAgICAgICAgIGZpbGVuYW1lOiAnW25hbWVdLltjaHVua2hhc2hdLmpzJyxcbiAgICAgICAgICAgICAgICBwdWJsaWNQYXRoOiBwYXRoLmpvaW4ocGF0aC5zZXAsIGJhc2VPdXRwdXQsIHBhdGguc2VwKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwbHVnaW5zOiBbbmV3IHdlYnBhY2suRW52aXJvbm1lbnRQbHVnaW4oY2xpZW50RW52KV0sXG4gICAgICAgIH0sXG4gICAgICAgIGV4dGVuZENvbmZpZyxcbiAgICAgICAgcGFnZUNvbmZpZy53ZWJwYWNrIHx8IHt9XG4gICAgKVxuXG4gICAgcmV0dXJuIHdlYnBhY2tDb25maWdcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkZXIoYnVpbGRlckNvbmZpZywgZGV2ID0gZmFsc2UpIHtcbiAgICBpZiAoZGV2KSB7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb25maWcuZGV2U2VydmVyXG4gICAgICAgIGNvbnN0IHNlcnZlciA9IG5ldyBXZWJwYWNrRGV2U2VydmVyKHdlYnBhY2soYnVpbGRlckNvbmZpZyksIG9wdGlvbnMpXG5cbiAgICAgICAgc2VydmVyLmxpc3RlbihvcHRpb25zLnBvcnQsICdsb2NhbGhvc3QnLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgJ1dlYnBhY2tEZXZTZXJ2ZXIgbGlzdGVuaW5nIGF0IGxvY2FsaG9zdDonLFxuICAgICAgICAgICAgICAgIG9wdGlvbnMucG9ydFxuICAgICAgICAgICAgKVxuICAgICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICAgIHdlYnBhY2soYnVpbGRlckNvbmZpZywgKGVyciwgc3RhdHMpID0+IHtcbiAgICAgICAgICAgIC8vIGh0dHBzOi8vd2VicGFjay5qcy5vcmcvYXBpL25vZGUvI2Vycm9yLWhhbmRsaW5nXG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIuc3RhY2sgfHwgZXJyKTtcbiAgICAgICAgICAgICAgICBpZiAoZXJyLmRldGFpbHMpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIuZGV0YWlscyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgaW5mbyA9IHN0YXRzLnRvSnNvbigpO1xuXG4gICAgICAgICAgICBpZiAoc3RhdHMuaGFzRXJyb3JzKCkpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGluZm8uZXJyb3JzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHN0YXRzLmhhc1dhcm5pbmdzKCkpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oaW5mby53YXJuaW5ncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuLyoqXG4gKiBUaGUgZGVmYXVsdCBmb3Igb3B0aW9ucy50ZW1wbGF0ZVBhcmFtZXRlclxuICogR2VuZXJhdGUgdGhlIHRlbXBsYXRlIHBhcmFtZXRlcnNcbiAqL1xuZnVuY3Rpb24gZ2VuVGVtcGxhdGVQYXJhbWV0ZXJzR2VuZXJhdG9yKGVudHJ5KSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIHRlbXBsYXRlUGFyYW1ldGVyc0dlbmVyYXRvcihjb21waWxhdGlvbiwgYXNzZXRzLCBvcHRpb25zKSB7XG4gICAgICAgIC8vIFRyeSB0byB1c2UgYWJzb2x1dGUgcGF0aCB3aGlsZSBsb2FkaW5nIHN0eWxlc2hlZXRcbiAgICAgICAgaWYgKGFzc2V0cy5leHRyYWN0ZWQgJiYgYXNzZXRzLmV4dHJhY3RlZC5jc3MpIHtcbiAgICAgICAgICAgIGFzc2V0cy5leHRyYWN0ZWQuY3NzLmZvckVhY2goKGNzcykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgIXBhdGguaXNBYnNvbHV0ZShjc3MuZmlsZSkgJiZcbiAgICAgICAgICAgICAgICAgICAgY3NzLmZpbGUuaW5kZXhPZihhc3NldHMucHVibGljUGF0aCkgPCAwXG4gICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIGNzcy5maWxlID0gcGF0aC5qb2luKGFzc2V0cy5wdWJsaWNQYXRoLCBjc3MuZmlsZSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0aXRsZTogZW50cnkudGl0bGUgfHwgZW50cnkudGVtcGxhdGVQYXJhbWV0ZXJzLnRpdGxlLFxuICAgICAgICAgICAgLi4uZW50cnkudGVtcGxhdGVQYXJhbWV0ZXJzLFxuICAgICAgICAgICAgY29tcGlsYXRpb24sXG4gICAgICAgICAgICB3ZWJwYWNrQ29uZmlnOiBlbnRyeS5vcHRpb25zLFxuICAgICAgICAgICAgaHRtbFdlYnBhY2tQbHVnaW46IHtcbiAgICAgICAgICAgICAgICBmaWxlczogYXNzZXRzLFxuICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsXG4gICAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIEZhY3RvcnkgZnVuY3Rpb24gZm9yIGdlbmVyYXRpbmcgSFRNTFdlYnBhY2tQbHVnaW4gaW5zdGFuY2VcbiAqIEBwYXJhbSB7c3RyaW5nfSBidWlsZFR5cGUgJ2RldicgfCAncHJvZCdcbiAqIEBwYXJhbSB7e1xuICogIHRpdGxlLFxuICogIGVudHJ5LFxuICogIG91dHB1dCxcbiAqICB0ZW1wbGF0ZT8sXG4gKiAgdGVtcGxhdGVQYXJhbWV0ZXJzP319IGVudHJ5XG4gKiBAcGFyYW0gZW50cnlOYW1lXG4gKiBAcGFyYW0ge3N0cmluZ30gaHRtbEZpbGVuYW1lXG4gKiBAcmV0dXJucyB7SHRtbFdlYnBhY2tQbHVnaW59XG4gKi9cbmZ1bmN0aW9uIGdlbkh0bWxXZWJwYWNrUGx1Z2luQ29uZmlnKFxuICAgIGJ1aWxkVHlwZSxcbiAgICBlbnRyeSxcbiAgICBlbnRyeU5hbWUsXG4gICAgZmlsZW5hbWUgPSAnaW5kZXguaHRtbCdcbikge1xuICAgIGNvbnN0IHRlbXBsYXRlID0gZW50cnkudGVtcGxhdGVcbiAgICAgICAgPyByZXNvbHZlUGF0aChlbnRyeS50ZW1wbGF0ZSlcbiAgICAgICAgOiBjb25maWcuZGVmYXVsdFRlbXBsYXRlXG5cbiAgICBpZiAoYnVpbGRUeXBlID09PSBCdWlsZFR5cGUuZGV2KSB7XG4gICAgICAgIHJldHVybiBuZXcgSHRtbFdlYnBhY2tQbHVnaW4oe1xuICAgICAgICAgICAgZmlsZW5hbWUsXG4gICAgICAgICAgICB0ZW1wbGF0ZSxcbiAgICAgICAgICAgIGluamVjdDogdHJ1ZSxcbiAgICAgICAgICAgIGNodW5rczogWyd2ZW5kb3JzJywgZW50cnlOYW1lXSxcbiAgICAgICAgICAgIHRpdGxlOiBlbnRyeS50aXRsZSB8fCBlbnRyeS50ZW1wbGF0ZVBhcmFtZXRlcnMudGl0bGUsXG4gICAgICAgICAgICB0ZW1wbGF0ZVBhcmFtZXRlcnM6IGdlblRlbXBsYXRlUGFyYW1ldGVyc0dlbmVyYXRvcihlbnRyeSlcbiAgICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gbmV3IEh0bWxXZWJwYWNrUGx1Z2luKHtcbiAgICAgICAgICAgIGZpbGVuYW1lLFxuICAgICAgICAgICAgdGVtcGxhdGUsXG4gICAgICAgICAgICBpbmplY3Q6IHRydWUsXG4gICAgICAgICAgICBjaHVua3M6IFsndmVuZG9ycycsIGVudHJ5TmFtZV0sXG4gICAgICAgICAgICB0aXRsZTogZW50cnkudGl0bGUgfHwgZW50cnkudGVtcGxhdGVQYXJhbWV0ZXJzLnRpdGxlLFxuICAgICAgICAgICAgdGVtcGxhdGVQYXJhbWV0ZXJzOiBnZW5UZW1wbGF0ZVBhcmFtZXRlcnNHZW5lcmF0b3IoZW50cnkpLFxuICAgICAgICAgICAgbWluaWZ5OiB7XG4gICAgICAgICAgICAgICAgcmVtb3ZlQ29tbWVudHM6IHRydWUsXG4gICAgICAgICAgICAgICAgY29sbGFwc2VXaGl0ZXNwYWNlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJlbW92ZUF0dHJpYnV0ZVF1b3RlczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAvLyBtb3JlIG9wdGlvbnM6XG4gICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2thbmdheC9odG1sLW1pbmlmaWVyI29wdGlvbnMtcXVpY2stcmVmZXJlbmNlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gbmVjZXNzYXJ5IHRvIGNvbnNpc3RlbnRseSB3b3JrIHdpdGggbXVsdGlwbGUgY2h1bmtzIHZpYSBDb21tb25zQ2h1bmtQbHVnaW5cbiAgICAgICAgICAgIGNodW5rc1NvcnRNb2RlOiAnYXV0bydcbiAgICAgICAgfSlcbiAgICB9XG59XG4iXX0=